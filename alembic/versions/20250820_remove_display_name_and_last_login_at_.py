"""Remove display_name and last_login_at from users

Revision ID: 3ed0e60c8023
Revises: f842eea9d17e
Create Date: 2025-08-20 23:30:24.902584

"""
from collections.abc import Sequence

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '3ed0e60c8023'
down_revision: str | Sequence[str] | None = 'f842eea9d17e'
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('analysis_jobs', 'status',
               existing_type=sa.VARCHAR(length=20),
               comment='ì‘ì—… ìƒíƒœ (pending, processing, completed, failed)',
               existing_comment='ì‘ì—… ìƒíƒœ (pending, running, completed, failed)',
               existing_nullable=False)
    
    # ğŸ†• MANUAL: users í…Œì´ë¸”ì—ì„œ updated_at ì»¬ëŸ¼ë§Œ ì œê±°
    # (display_name, last_login_atì€ ì´ë¯¸ ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
    try:
        op.drop_index('idx_users_last_login', table_name='users')
    except Exception:
        pass  # ì¸ë±ìŠ¤ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
    
    try:
        op.drop_column('users', 'display_name')
    except Exception:
        pass  # ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ë¬´ì‹œ
        
    try:
        op.drop_column('users', 'last_login_at')
    except Exception:
        pass  # ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ë¬´ì‹œ
        
    # updated_at ì»¬ëŸ¼ë§Œ ì‹¤ì œë¡œ ì œê±°
    op.drop_column('users', 'updated_at')
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('analysis_jobs', 'status',
               existing_type=sa.VARCHAR(length=20),
               comment='ì‘ì—… ìƒíƒœ (pending, running, completed, failed)',
               existing_comment='ì‘ì—… ìƒíƒœ (pending, processing, completed, failed)',
               existing_nullable=False)
    
    # ğŸ†• MANUAL: ë¡¤ë°± ì‹œ ì»¬ëŸ¼ ë³µì›
    op.add_column('users', sa.Column('updated_at', sa.TIMESTAMP(timezone=True), 
                                    server_default=sa.text('now()'), nullable=True, 
                                    comment="í”„ë¡œí•„ ìˆ˜ì • ì¼ì‹œ"))
    op.add_column('users', sa.Column('last_login_at', sa.TIMESTAMP(timezone=True), 
                                    nullable=True, comment="ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„"))
    op.add_column('users', sa.Column('display_name', sa.String(length=100), 
                                    nullable=True, comment="í‘œì‹œ ì´ë¦„ (ì„ íƒ)"))
    
    # ì¸ë±ìŠ¤ ë³µì›
    op.create_index('idx_users_last_login', 'users', ['last_login_at'], unique=False)
    # ### end Alembic commands ###